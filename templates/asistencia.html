<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asistencia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        function confirmSave() {
            const totalItems = {{ total_items }};
            const selectedItems = document.querySelectorAll('input[name="asistencia_ids"]:checked').length;
            
            if (selectedItems === 0) {
                alert('Debe seleccionar al menos un ID para registrar la asistencia.');
                return false;
            }

            const confirmMessage = `Total de IDs: ${totalItems}\nIDs seleccionados: ${selectedItems}\n\n¿Está seguro de registrar la asistencia?`;
            return confirm(confirmMessage);
        }

        function handleFormSubmit(event) {
            event.preventDefault(); // Previene el envío del formulario tradicional

            const form = event.target;
            const formData = new FormData(form);

            if (!confirmSave()) {
                return; // Si el usuario cancela, no enviamos el formulario
            }

            fetch(form.action, {
                method: form.method,
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message); // Muestra el mensaje del servidor
                if (data.status === 'success') {
                    window.location.href = "{{ url_for('menu') }}"; // Redirige al menú
                }
            })
            .catch(error => {
                alert('Ocurrió un error: ' + error);
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Datos de Asistencia</h1>

        {% if mensaje %}
            <p>{{ mensaje }}</p>
        {% else %}
            <form action="{{ url_for('guardar_asistencia') }}" method="POST" onsubmit="handleFormSubmit(event)">
                <div class="asistencia-list">
                    {% for item in asistencia %}
                    <div class="asistencia-item">
                        <img src="{{ item['foto'] }}" alt="Foto del creyente" class="asistencia-pic">
                        <div class="asistencia-details">
                            <div><strong>ID:</strong> {{ item['id_creyente'] }}</div>
                            <div><strong>Nombre:</strong> {{ item['nombre'] }}</div>
                            <div><strong>Fecha de Nacimiento:</strong> {{ item['fecha_nac'] }}</div>
                        </div>
                        <input type="checkbox" name="asistencia_ids" value="{{ item['id_creyente'] }}">
                    </div>
                    {% endfor %}
                </div>
                
                <button type="submit">GUARDAR</button>
            </form>
        {% endif %}
        <a href="{{ url_for('menu') }}">Regresar al menú</a>
    </div>
    <script>
        document.querySelectorAll('input[name="asistencia_ids"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const selectedCount = document.querySelectorAll('input[name="asistencia_ids"]:checked').length;
                document.getElementById('selected-count').textContent = selectedCount;
            });
        });
    </script>
</body>
</html>
